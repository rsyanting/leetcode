

# 42 : æ¥é›¨æ°´

## ğŸ“Œé¢˜ç›®è¯¦æƒ…

[leetcode é¢˜ç›®åœ°å€](https://leetcode.com/problems/trapping-rain-water/)

[leetcode-cn é¢˜ç›®åœ°å€](https://leetcode-cn.com/problems/trapping-rain-water/)

ğŸ“—Difficultyï¼š**Hard**

ğŸ¯Tagsï¼š

+ **[åŒæŒ‡é’ˆ](https://leetcode-cn.com/tag/two-pointers/)** 
+ **[åŠ¨æ€è§„åˆ’](https://leetcode-cn.com/tag/dynamic-programming/)**
+ **[æ ˆ](https://leetcode-cn.com/tag/stack/)** 

---

## ğŸ“ƒé¢˜ç›®æè¿°

ç»™å®š `n` ä¸ªéè´Ÿæ•´æ•°è¡¨ç¤ºæ¯ä¸ªå®½åº¦ä¸º `1` çš„æŸ±å­çš„é«˜åº¦å›¾ï¼Œè®¡ç®—æŒ‰æ­¤æ’åˆ—çš„æŸ±å­ï¼Œä¸‹é›¨ä¹‹åèƒ½æ¥å¤šå°‘é›¨æ°´ã€‚

![å›¾ç¤º](https://assets.ryantech.ltd/20201015205427.png)

ä¸Šé¢æ˜¯ç”±æ•°ç»„ `[0,1,0,2,1,0,1,3,2,1,2,1]` è¡¨ç¤ºçš„é«˜åº¦å›¾ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥æ¥ `6` ä¸ªå•ä½çš„é›¨æ°´ï¼ˆè“è‰²éƒ¨åˆ†è¡¨ç¤ºé›¨æ°´ï¼‰ã€‚



**æ ·ä¾‹ 1ï¼š**

```
è¾“å…¥: [0,1,0,2,1,0,1,3,2,1,2,1]
è¾“å‡º: 6
```



****

## ğŸ¹ğŸ¯è§£é¢˜æ€è·¯

### 1. æš´åŠ›è§£æ³•

å¯¹äºæ¯ä¸€ä¸ªä½ç½®çš„ `height[i]`ï¼Œå®ƒæœ€å¤šå¯ä»¥æ¥çš„é›¨æ°´é‡ï¼Œæ˜¯å®ƒå·¦å³ä¸¤è¾¹é«˜åº¦çš„**æœ€å°å€¼** å‡å» å½“å‰æŸ±å­çš„é«˜åº¦ã€‚æ‰€ä»¥ï¼Œå¯ä»¥ä»å½“å‰ä½ç½®å‡ºå‘ï¼Œå‘å·¦å¯»æ‰¾æœ€é«˜çš„æŸ±å­ `max_left`ï¼›å†å‘å³å‡ºå‘ï¼Œå¯»æ‰¾å³è¾¹çš„æœ€é«˜çš„æŸ±å­ `max_right` ã€‚

è¿™æ ·å¯èƒ½ä¸å¤ªç›´è§‚å®¹æ˜“ç†è§£ï¼Œå¦‚æœé…åˆå›¾ç¤ºï¼Œæ›´åŠ å®¹æ˜“ç†è§£ã€‚

![å›¾ç¤º](https://assets.ryantech.ltd/20201015205427.png)

> å®é™…ä¸Šï¼Œç¬¬ä¸€æ¬¡é‡åˆ°è¿™æ ·çš„é¢˜ç›®ï¼Œæš´åŠ›çš„è§£æ³•ï¼Œå¤§éƒ¨åˆ†äººå¹¶ä¸ä¸€å®šå¯ä»¥ç†è§£æ€è€ƒå‡ºæ¥ã€‚

åœ¨ `height[3]` çš„ä½ç½®ï¼Œ`max_left = 2`ï¼Œ`max_right= 3`ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯æ¬¡éƒ½ä» `i` ä½ç½®å¼€å§‹å¯»æ‰¾ï¼ŒåŒ…æ‹¬ `i` ä½ç½®ã€‚



#### ä»£ç å®ç°

```java
// æš´åŠ›è§£æ³•
public int trap(int[] height) {
    int res = 0;
    int len = height.length;

    if (len < 3) {
        return 0;
    }

    for (int i = 1; i < len - 1; i++) {
        int max_left = 0, max_right = 0;
        for (int j = i; j >= 0; j--) {
            max_left = Math.max(max_left, height[j]);
        }

        for (int j = i; j < len; j++) {
            max_right = Math.max(max_right, height[j]);
        }

        res += Math.min(max_left, max_right) - height[i];
    }
    return res;
}
```



#### å¤æ‚åº¦åˆ†æ

+ æ—¶é—´å¤æ‚åº¦ï¼š`O(n ^ 2)` ã€‚
+ ç©ºé—´å¤æ‚åº¦ï¼š`O(1)` ã€‚

---

### 2. åŠ¨æ€è§„åˆ’

æš´åŠ›æ³•çš„é—®é¢˜åœ¨äºï¼Œè¿›è¡Œäº†è¿‡å¤šæ¬¡æ•°çš„é‡å¤è®¡ç®—ï¼Œå¦‚æœå¯¹äºæ¯ä¸ªä½ç½® `i`ï¼Œèƒ½å¤Ÿåœ¨ `O(1)` çš„æ—¶é—´é‡Œé¢ï¼Œè·å¾— `max_left` å’Œ `max_right`ï¼Œé‚£ä¹ˆå¯ä»¥é™ä½å¤æ‚åº¦åˆ° `O(n)` ã€‚

é‚£ä¹ˆä¸€ä¸ªæ€è·¯å°±æ˜¯ï¼Œå…ˆè¡Œè®¡ç®—å‡º `max_left` å¹¶ä¸”å°†å…¶å­˜å‚¨åœ¨æ•°ç»„ä¸­ã€‚

![å…ˆè¡Œæ±‚è§£](https://assets.ryantech.ltd/20201015220145.png)

å¦‚å›¾æ‰€ç¤ºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ±‚è§£çš„æ–¹å¼æ˜¯ï¼šå¯¹äº `i` ä½ç½®çš„å…ƒç´ ï¼Œä» `i` å¼€å§‹å‘å³çœ‹ï¼Œæ±‚è§£å…¶æœ€å¤§çš„é«˜åº¦ã€‚

ç„¶åï¼Œæ€è·¯å’Œæš´åŠ›æ³•ä¸€è‡´ï¼Œæ¯ä¸ªä½ç½®çš„æ¥æ°´é‡æ˜¯å·¦å³æœ€å¤§å€¼ä¸­çš„è¾ƒå°å€¼å‡å»å½“å‰çš„é«˜åº¦ã€‚



```java
// æå‰å­˜å‚¨å¥½ max_left å’Œ max_right
public int trap(int[] height) {
    int res = 0;
    int len = height.length;

    // ç‰¹åˆ¤ï¼Œå¦‚æœå°äº 3 ä¸ªé«˜åº¦ï¼Œé‚£ä¹ˆæ²¡åŠæ³•å­˜å‚¨é›¨æ°´
    if (len < 3) {
        return 0;
    }

    int[] max_left_arr = new int[len];
    int[] max_right_arr = new int[len];
    max_left_arr[0] = height[0];
    max_right_arr[len - 1] = height[len - 1];

    for (int i = 1; i < len; i++) {
        max_left_arr[i] = Math.max(max_left_arr[i - 1], height[i]);
    }

    for (int i = len - 2; i >= 0; i--) {
        max_right_arr[i] = Math.max(max_right_arr[i + 1], height[i]);
    }

    for (int i = 0; i < len; i++) {
        res += Math.min(max_left_arr[i], max_right_arr[i]) - height[i];
    }

    return res;
}
```



#### å¤æ‚åº¦åˆ†æ

+ æ—¶é—´å¤æ‚åº¦ï¼š`O(n)` ã€‚éå†ä¸‰æ¬¡æ•°ç»„ï¼Œå¤æ‚åº¦ä¸º `O(n)` ã€‚
+ ç©ºé—´å¤æ‚åº¦ï¼š`O(n)` ã€‚éœ€è¦é¢å¤–çš„ç©ºé—´æ¥å­˜å‚¨æ¯ä¸ªä½ç½®çš„å·¦è¾¹å³è¾¹æœ€å¤§é«˜åº¦ã€‚



---

### 3. åˆ©ç”¨å•è°ƒæ ˆæ¥è¾…åŠ©

ç»´æŠ¤ä¸€ä¸ªé€’å‡å•è°ƒæ ˆï¼Œé‡åˆ°æ¯”å½“å‰æ ˆé¡¶å…ƒç´ ä½çš„ï¼Œè¯´æ˜å¯ä»¥å½¢æˆä¸€ä¸ªä½æ´¼åŒºåŸŸï¼Œè®¡ç®—è¯¥ä½æ´¼åŒºåŸŸçš„ç§¯æ°´é‡ã€‚

ä»å·¦å‘å³æ‰«æä¸€æ¬¡å³å¯ã€‚



![å•è°ƒæ ˆæ€è·¯](https://assets.ryantech.ltd/20201015220650.png)



![ä¸€ä¸ªæ ·ä¾‹](https://assets.ryantech.ltd/20201015220959.png)

åœ¨ä¸Šå›¾çš„ä¾‹å­ä¸­ï¼Œ`top` æ‰€åœ¨çš„ä½ç½®æ˜¯ä½æ´¼åŒºåŸŸï¼ŒåŸå…ˆçš„æ ˆé¡¶æ˜¯ `top` æ‰€åœ¨çš„ä½ç½®é«˜åº¦ã€‚



```java
// é€’å‡å•è°ƒæ ˆ æ€è·¯
public int trap(int[] height) {
    int res = 0;
    int len = height.length;

    // ç‰¹åˆ¤ï¼Œå¦‚æœå°äº 3 ä¸ªé«˜åº¦ï¼Œé‚£ä¹ˆæ²¡åŠæ³•å­˜å‚¨é›¨æ°´
    if (len < 3) {
        return 0;
    }

    Deque<Integer> stack = new ArrayDeque<>();
    int idx = 0;
    while (idx < len) {
        while (!stack.isEmpty() && height[idx] > height[stack.peekLast()]) {
            int valley = stack.pollLast(); // å¼¹å‡ºå½“å‰æ ˆé¡¶ï¼Œå½“å‰æ ˆé¡¶å¯¹åº”çš„ idx å¤„å½¢æˆä½æ´¼
            if (stack.isEmpty()) {
                break; // å¦‚æœä¸ºç©ºï¼Œè¯´æ˜æ²¡æœ‰å·¦è¾¹ç•Œæ¥å½¢æˆä½æ´¼ï¼Œè·³å‡ºå¾ªç¯å³å¯
            }
            int width = idx - stack.peekLast() - 1; // ç§¯æ°´å®½åº¦
            int valley_depth = Math.min(height[idx], height[stack.peekLast()]) - height[valley];
            res += width * valley_depth;
        }
        stack.offerLast(idx++);
    }

    return res;
}
```



#### å¤æ‚åº¦åˆ†æ

+ æ—¶é—´å¤æ‚åº¦ï¼š`O(n)` ã€‚éå†ä¸‰æ¬¡æ•°ç»„ï¼Œå¤æ‚åº¦ä¸º `O(n)` ã€‚
+ ç©ºé—´å¤æ‚åº¦ï¼š`O(n)` ã€‚éœ€è¦é¢å¤–çš„ç©ºé—´æ¥å­˜å‚¨æ¯ä¸ªä½ç½®çš„å·¦è¾¹å³è¾¹æœ€å¤§é«˜åº¦ã€‚



---

### 4. åŒæŒ‡é’ˆæ€è·¯

åœ¨åŠ¨æ€è§„åˆ’çš„åŸºç¡€ä¸Šï¼Œå¯ä»¥æ€»ç»“å‡ºè¿™ä¹ˆä¸€ä¸ªæƒ…å†µï¼šå¦‚æœ `max_left_arr[i] > max_right_arr[i]`ï¼Œç§¯æ°´çš„é«˜åº¦å°†æœ‰ `max_rigth_arr[i]` å†³å®šï¼Œåè¿‡æ¥çš„è¯ï¼Œç”± `max_left_arr[i]` å†³å®šã€‚

é‚£ä¹ˆä¹Ÿå°±æ˜¯ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå•è°ƒä¸‹é™åŒºé—´ï¼Œå…¶ç§¯æ°´é‡ï¼Œç”±å³è¾¹çš„é«˜åº¦å†³å®šï¼›ä¸€ä¸ªå•è°ƒä¸Šå‡åŒºé—´ï¼Œå…¶æ¥æ°´é‡ç”±å·¦è¾¹çš„é«˜åº¦å†³å®šã€‚

![](https://assets.ryantech.ltd/20201015221825.png)

é‚£ä¹ˆï¼Œå¯ä»¥è®¾ç½® 2 ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«ä»å·¦å’Œä»å³å¼€å§‹å‘ä¸­é—´ç§»åŠ¨ï¼Œæ¥è®¡ç®—ç§¯æ°´é‡ã€‚



```java
// åŒæŒ‡é’ˆ æ€è·¯
// ä» åŠ¨æ€è§„åˆ’ æ€æƒ³å»¶å±•å¼€æ¥
public int trap(int[] height) {
    int res = 0;
    int len = height.length;

    // ç‰¹åˆ¤ï¼Œå¦‚æœå°äº 3 ä¸ªé«˜åº¦ï¼Œé‚£ä¹ˆæ²¡åŠæ³•å­˜å‚¨é›¨æ°´
    if (len < 3) {
        return 0;
    }

    int left_max = 0, right_max = 0;
    int left = 0, right = len - 1; // æ•°ç»„çš„ä¸‹æ ‡èŒƒå›´
    while (left < right) {
        if (height[left] < height[right]) {
            if (height[left] > left_max) {
                left_max = height[left];
            } else {
                res += left_max - height[left]; // æ­¤å¤„å¯ä»¥ç§¯æ°´ï¼Œè®¡ç®—ç§¯æ°´é‡
            }
            left++;
        } else {
            if (height[right] > right_max) {
                right_max = height[right];
            } else {
                res += right_max - height[right]; // æ­¤å¤„å¯ä»¥ç§¯æ°´ï¼Œè®¡ç®—ç§¯æ°´é‡
            }
            right--;
        }
    }

    return res;
}
```



#### å¤æ‚åº¦åˆ†æ

+ æ—¶é—´å¤æ‚åº¦ï¼š`O(n)` ã€‚éå†ä¸€æ¬¡æ•°ç»„ï¼Œå¤æ‚åº¦ä¸º `O(n)` ã€‚
+ ç©ºé—´å¤æ‚åº¦ï¼š`O(1)` ã€‚



---

## ğŸ’¡æ€»ç»“

### ç›¸ä¼¼é¢˜ç›®

#### [84. æŸ±çŠ¶å›¾ä¸­æœ€å¤§çš„çŸ©å½¢](https://leetcode-cn.com/problems/largest-rectangle-in-histogram/)

```java
// ä½¿ç”¨æ ˆä½œä¸ºè¾…åŠ©
public int largestRectangleArea(int[] heights) {
    int len = heights.length;
    if (len == 0) {
        return 0;
    }

    if (len == 1) {
        return heights[0];
    }

    int area = 0;
    Deque<Integer> stack = new LinkedList<>();

    for (int i = 0; i < len; i++) {
        while (!stack.isEmpty() && heights[stack.peekLast()] > heights[i]) {
            int curHeight = heights[stack.pollLast()];
            // è¿™ä¸ª while å¾ˆå…³é”®ï¼Œå› ä¸ºæœ‰å¯èƒ½ä¸æ­¢ä¸€ä¸ªæŸ±å½¢çš„æœ€å¤§å®½åº¦å¯ä»¥è¢«è®¡ç®—å‡ºæ¥
            while (!stack.isEmpty() && heights[stack.peekLast()] == curHeight) {
                stack.pollLast();
            }

            int curWidth;
            if (stack.isEmpty()) {
                curWidth = i;
            } else {
                curWidth = i - stack.peekLast() - 1;
            }

            area = Math.max(area, curWidth * curHeight);
        }

        stack.offerLast(i);
    } // end of for

    // éå†å®Œæˆï¼Œä½†æ˜¯æ ˆä¸­å¯èƒ½è¿˜æœ‰å…ƒç´ ï¼Œå¥—ç”¨ä¸Šé¢çš„æ€è·¯ï¼Œç»§ç»­å¤„ç†
    while (!stack.isEmpty()) {
        int curHeight = heights[stack.pollLast()];

        // æ ˆä¸­å­˜åœ¨ç›¸åŒçš„å…ƒç´ ï¼Œå°†æ–°æ ˆé¡¶çš„å…ƒç´ ï¼Œå³ç›¸åŒçš„å…ƒç´ å¼¹å‡º
        while (!stack.isEmpty() && heights[stack.peekLast()] == curHeight) {
            stack.pollLast();
        }

        int curWeight;
        if (stack.isEmpty()) { // éå†å®Œæˆåï¼Œä¸”å¼¹æ ˆç»“æŸåï¼Œæ ˆä¸ºç©ºï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼Œè¯¥ä½ç½®ä¸€å®šå¯ä»¥å‘å·¦å‘å³å»¶ç”³åˆ°åº•
            curWeight = len;
        } else {
            curWeight = len - stack.peekLast() - 1; // æ ˆä¸ä¸ºç©ºï¼Œæ­¤æ—¶ï¼Œå…ƒç´ å¯ä»¥å‘å³å»¶ç”³åˆ°åº•ï¼Œå‘å·¦æœ€å¤šå»¶ç”³åˆ°æ ˆé¡¶å…ƒç´ ä½ç½®
        }

        area = Math.max(area, curWeight * curHeight);
    }

    return area;
}
```



